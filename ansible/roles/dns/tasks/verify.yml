# roles/dns/tasks/verify.yml

- name: Normalize zone name (strip trailing dot)
  ansible.builtin.set_fact:
    _dns_zone: "{{ dns_zone_name | regex_replace('\\.$', '') }}"

- name: Pick DNS server IP from dns_a_records (ns1) or fallback to ansible_host
  ansible.builtin.set_fact:
    _dns_server_ip: >-
      {{
        (dns_a_records | selectattr('name', 'equalto', 'ns1') | map(attribute='ip') | first)
        | default(ansible_host, true)
      }}

- name: Init expected map
  ansible.builtin.set_fact:
    _expect_map: {}

- name: Build expected fqdn -> list of IPs (supports wildcard + multi-A)
  ansible.builtin.set_fact:
    _expect_map: "{{ _expect_map | combine({ fqdn: (_expect_map[fqdn] | default([])) + [item.ip] }) }}"
  vars:
    raw_name: "{{ (item.name | string) | trim }}"
    # Replace wildcard '*' with 'ci' so we can query a concrete name
    qname: "{{ raw_name | regex_replace('\\*', 'ci') }}"
    # If name ends with '.' treat as absolute FQDN; otherwise relative to zone
    fqdn: >-
      {{
        (qname | regex_replace('\\.$', '')) if (qname is match('.*\\.$'))
        else (qname ~ '.' ~ _dns_zone)
      }}
  loop: "{{ dns_a_records }}"
  loop_control:
    label: "{{ item.name }} -> {{ item.ip }}"

# --------------------------
# BIND checks in container
# --------------------------

- name: named-checkconf (in container)
  ansible.builtin.command: >
    docker exec {{ dns_container_name }} named-checkconf -z -c /etc/bind/named.conf
  changed_when: false

- name: named-checkzone (in container)
  ansible.builtin.command: >
    docker exec {{ dns_container_name }} named-checkzone {{ _dns_zone }} /etc/bind/zones/{{ dns_zone_file }}
  changed_when: false

# --------------------------
# DIG checks (live)
# --------------------------

- name: SOA (UDP, norecurse) must answer
  ansible.builtin.command: >
    dig @{{ _dns_server_ip }} {{ _dns_zone }} SOA +short +norecurse
  register: soa_udp
  changed_when: false

- name: Assert SOA UDP not empty
  ansible.builtin.assert:
    that:
      - (soa_udp.stdout | trim) != ""
    fail_msg: "SOA UDP is empty for {{ _dns_zone }} via {{ _dns_server_ip }}"

- name: SOA comments (AA flag + no RA)
  ansible.builtin.command: >
    dig @{{ _dns_server_ip }} {{ _dns_zone }} SOA +norecurse +noall +comments
  register: soa_comments
  changed_when: false

- name: Extract flags line
  ansible.builtin.set_fact:
    _flags_line: "{{ (soa_comments.stdout_lines | select('search', '^;; flags:') | list | first) | default('') }}"

- name: Assert authoritative (AA) and recursion disabled (no RA)
  ansible.builtin.assert:
    that:
      - _flags_line != ""
      - _flags_line is search('\\baa\\b')
      - not (_flags_line is search('\\bra\\b'))
    fail_msg: "Flags line check failed. flags_line={{ _flags_line }}"

- name: NS must include ns1.<zone>.
  ansible.builtin.command: >
    dig @{{ _dns_server_ip }} {{ _dns_zone }} NS +short +norecurse
  register: ns_out
  changed_when: false

- name: Assert NS contains ns1.<zone>.
  ansible.builtin.assert:
    that:
      - (ns_out.stdout_lines | select('equalto', 'ns1.' ~ _dns_zone ~ '.') | list | length) > 0
    fail_msg: "NS for {{ _dns_zone }} does not contain ns1.{{ _dns_zone }}. Output={{ ns_out.stdout | replace('\n',' ') }}"

# --------------------------
# A records checks from host_vars
# (dig + assert in the same loop => no loop.index0 bug)
# --------------------------

- name: Query A records for each fqdn in expect_map
  ansible.builtin.command: >
    dig @{{ _dns_server_ip }} {{ item.key }} A +short +norecurse
  register: dig_a
  changed_when: false
  loop: "{{ _expect_map | dict2items }}"
  loop_control:
    label: "{{ item.key }} expect={{ item.value | sort | join(',') }}"

- name: Assert A answers match expected (order-insensitive, supports multi-A)
  vars:
    expected: "{{ item.value | list | sort }}"
    got: >-
      {{
        (dig_a.results
          | selectattr('item.key', 'equalto', item.key)
          | map(attribute='stdout_lines')
          | first
          | default([])
        )
        | map('trim')
        | reject('equalto','')
        | list
        | sort
      }}
  ansible.builtin.assert:
    that:
      - got == expected
    fail_msg: >-
      A mismatch for {{ item.key }}.
      expected={{ expected | join(', ') }}
      got={{ got | join(', ') }}
  loop: "{{ _expect_map | dict2items }}"
  loop_control:
    label: "{{ item.key }}"

